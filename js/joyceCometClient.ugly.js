var joyceCometClient=function(){var t=function(t,e){this.client=t,this.token=null,this.queue_out=e.initial_messages?e.initial_messages:[],this.pending_requests=0,this.message="message"in e?e.message:function(){},this.stream="stream"in e?e.stream:function(){},this.ready="ready"in e?e.ready:function(){},this.stream_url=null};t.prototype.run=function(){this._request(!1)},t.prototype._request=function(t){if(!(t&&this.pending_requests>=2||!t&&this.pending_requests>=1)){this.pending_requests++;var e=[this.token];$.merge(e,this.queue_out),this.queue_out=[];var s="http://"+this.client.host+":"+(""+this.client.port)+this.client.path,n=this;$.ajax({url:s,jsonp:"c",data:{m:JSON.stringify(e)},crossDomain:!0,dataType:"jsonp",error:function(t,e,s){n.on_error(t,e,s)},success:function(t,e,s){n.on_success(t,e,s)}})}},t.prototype.on_success=function(t){var e=!1;if(this.pending_requests--,null!=this.token&&t[0]!=this.token)return alert("error: token changed: "+this.token+" != "+t[0]),void 0;null==this.token&&(this.token=t[0],this.stream_url="http://"+this.client.host+":"+(""+this.client.port)+this.client.path+"?m="+this.token+"&r=fu",e=!0);for(var s=0;t[1].length>s;s++)this.message(t[1][s]);this._request(!1),e&&this.ready()},t.prototype.send_messages=function(t){$.merge(this.queue_out,t),null!=this.token&&this._request(!0)},t.prototype.send_message=function(t){this.queue_out.push(t),null!=this.token&&this._request(!0)},t.prototype.on_error=function(t,e,s){console.error([e,s])};var e=function(t){this.host="host"in t?t.host:"localhost",this.port="port"in t?t.port:8080,this.path="path"in t?t.path:"/"};return e.prototype.create_channel=function(e){var s=new t(this,e);return s.run(),s},e}();