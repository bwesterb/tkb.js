(function(){function o(){this.comet=null,this.roomMapVersion=-1,this.occupationVersion=-1,this.scheduleVersion=-1,this.roomMap={},this.occupation={},this.schedule={},this.rroomMap={},this.roomToDom={},this.rooms=[],this.maxPcsPerRoom=1,this.schedTimeout=null,this.firstOccupation=!0,this.msg_map={welcome:this.msg_welcome,tags:this.msg_tags,occupation:this.msg_occupation,roomMap:this.msg_roomMap,schedule:this.msg_schedule,occupation_update:this.msg_occupation_update}}o.prototype.setup_comet=function(){var o=this,t={};tkbConfig.hasOwnProperty("host")&&(t.host=tkbConfig.host),tkbConfig.hasOwnProperty("port")&&(t.port=tkbConfig.port),tkbConfig.hasOwnProperty("path")&&(t.path=tkbConfig.path);var s=tkbConfig.hasOwnProperty("tags")?tkbConfig.tags:null;this.comet=new joyceCometClient(t),this.channel=this.comet.create_channel({initial_messages:[{type:"set_msgFilter",schedule:s,occupation:s,roomMap:s},{type:"get_roomMap"},{type:"get_schedule"},{type:"get_occupation"}],message:function(t){var s=t.type;s in o.msg_map?o.msg_map[s].call(o,t):console.warn(["I don't know how to handle",t])}})},o.prototype.run=function(){this.setup_comet()},o.prototype.msg_tags=function(){},o.prototype.msg_welcome=function(){},o.prototype.msg_schedule=function(o){this.schedule=o.schedule,this.scheduleVersion=o.version,this.ui_update_schedule()},o.prototype.msg_occupation=function(o){this.occupation=o.occupation,this.occupationVersion=o.version,this.ui_update_rooms(this.rooms,!1),this.firstOccupation&&(this.firstOccupation=!1,window.scrollTo(0,1))},o.prototype.msg_occupation_update=function(o){this.occupationVersion++;var t={},s=[];for(var e in o.update){var i=this.rroomMap[e];t[i]||(t[i]=!0,s.push(i)),this.occupation[e]=o.update[e]}this.ui_update_rooms(s,!0)},o.prototype.msg_roomMap=function(o){var t=this;this.roomMap=o.roomMap,this.roomMapVersion=o.version,this.rroomMap={},this.rooms=[],this.maxPcsPerRoom=1;for(var s in this.roomMap){this.rooms.push(s),this.maxPcsPerRoom=Math.max(this.maxPcsPerRoom,this.roomMap[s][1].length);for(var e=0;this.roomMap[s][1].length>e;e++)this.rroomMap[this.roomMap[s][1][e]]=s}this.rooms.sort(function(o,s){return t.roomMap[s][1].length-t.roomMap[o][1].length}),this.ui_refresh_rooms(this.rooms)},o.prototype.ui_refresh_rooms=function(){this.roomToDom={},$("#list > .rows").empty();for(var o=!0,t=0;this.rooms.length>t;t++){var s=this.rooms[t],e=o?"odd":"even",i=$("<div class='"+e+"'><div class='bar'><div>"+"<div class='u'><div></div></div>"+"<div class='f'><div></div></div>"+"</div></div>"+"<div class='name'>"+this.roomMap[s][0]+"</div>"+"<div class='count'></div>"+"<div class='sched'><span class='screen'></span>"+"<span class='mobile'></span></div>"+"</div>");this.roomToDom[s]=i,$("#list > .rows").append(i),o=!o}this.ui_update_rooms(this.rooms,!1)},o.prototype.ui_update_schedule=function(){for(var o=this,t=new Date,s=[t.getHours(),t.getMinutes()],e=function(o,t){return 60*t[0]+t[1]-(60*o[0]+o[1])},i=function(o,t){return e(o,t)>=0},r=function(o){var t=""+o[1];return 1==t.length&&(t="0"+t),o[0]+":"+t},n=null,a=0;this.rooms.length>a;a++){var h=this.rooms[a],c=this.schedule[h];if(c){c.sort(function(o,t){return-e(o[0],t[0])});var u,m;for(u=0;c.length>u&&i(c[u][1],s);u++);for(m=u;c.length>m+1&&15>e(c[m][1],c[m+1][0]);m++);var p=null,l="",d="",f=null;u==c.length||(i(c[u][0],s)?(d="gereserveerd tot "+r(c[m][1]),f="resNow",p=c[u][1],l=m==u?"gereserveerd tot "+r(c[u][1])+" voor “"+c[u][2]+"”":"gereserveerd tot "+r(c[m][1])+". Nu: “"+c[u][2]+"”"):(d="gereserveerd "+r(c[u][0])+"–"+r(c[m][1]),l=m==u?"gereserveerd vanaf  "+r(c[u][0])+" tot "+r(c[u][1])+" voor “"+c[u][2]+"”":"gereserveerd vanaf  "+r(c[u][0])+" tot "+r(c[m][1])+". Eerst: “"+c[u][2]+"”",f="resLater",p=c[u][0])),null==p||null!=n&&!i(p,n)||(n=p),this.roomToDom[h].find(".sched > .screen").text(l),this.roomToDom[h].find(".sched > .mobile").html(d);var g=this.roomToDom[h].find(".bar > div");g.removeClass(),f&&g.addClass(f)}}if(null!=n){var v=new Date(t.getUTCFullYear(),t.getMonth(),t.getDate(),n[0],n[1]);null!=this.schedTimeout&&clearTimeout(this.schedTimeout),this.schedTimeout=setTimeout(function(){o.ui_update_schedule()},v-t)}},o.prototype.ui_update_rooms=function(o,t){for(var s=0;o.length>s;s++){for(var e=o[s],i=this.roomToDom[e],r={wf:0,lf:0,o:0,wu:0,wx:0,lu:0,lx:0,x:0},n=0;this.roomMap[e][1].length>n;n++){var a=this.occupation[this.roomMap[e][1][n]];r[a]++}var h=r.wf+r.lf+r.o,c=r.wu+r.wx+r.lu+r.lx+r.x,u=100/this.maxPcsPerRoom,m={width:u*h+"%"},p={width:u*(c+h)+"%"};t?(i.find(".f").animate(m),i.find(".u").animate(p)):(i.find(".f").css(m),i.find(".u").css(p)),i.find(".count").text(h+"/"+(c+h)),t&&i.stop(!0,!0,!0).effect("highlight",{},1e3)}},$(document).ready(function(){setTimeout(function(){tkb=new o,tkb.run()},0)})})();