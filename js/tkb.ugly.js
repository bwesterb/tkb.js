(function(){function o(){this.comet=null,this.roomMapVersion=-1,this.occupationVersion=-1,this.scheduleVersion=-1,this.roomMap={},this.occupation={},this.schedule={},this.rroomMap={},this.roomToDom={},this.rooms=[],this.maxPcsPerRoom=1,this.schedTimeout=null,this.firstOccupation=!0,this.msg_map={welcome:this.msg_welcome,tags:this.msg_tags,occupation:this.msg_occupation,roomMap:this.msg_roomMap,schedule:this.msg_schedule,occupation_update:this.msg_occupation_update}}o.prototype.setup_comet=function(){var o=this,t={};tkbConfig.hasOwnProperty("host")&&(t.host=tkbConfig.host),tkbConfig.hasOwnProperty("port")&&(t.port=tkbConfig.port),tkbConfig.hasOwnProperty("path")&&(t.path=tkbConfig.path);var s=tkbConfig.hasOwnProperty("tags")?tkbConfig.tags:null;this.comet=new joyceCometClient(t),this.channel=this.comet.create_channel({initial_messages:[{type:"set_msgFilter",schedule:s,occupation:s,roomMap:s},{type:"get_roomMap"},{type:"get_schedule"},{type:"get_occupation"}],message:function(t){var s=t.type;s in o.msg_map?o.msg_map[s].call(o,t):console.warn(["I don't know how to handle",t])}})},o.prototype.run=function(){this.setup_comet()},o.prototype.msg_tags=function(){},o.prototype.msg_welcome=function(){},o.prototype.msg_schedule=function(o){this.schedule=o.schedule,this.scheduleVersion=o.version,this.ui_update_schedule()},o.prototype.msg_occupation=function(o){this.occupation=o.occupation,this.occupationVersion=o.version,this.ui_update_rooms(this.rooms,!1),this.firstOccupation&&(this.firstOccupation=!1,window.scrollTo(0,1))},o.prototype.msg_occupation_update=function(o){this.occupationVersion++;var t={},s=[];for(var i in o.update){var e=this.rroomMap[i];t[e]||(t[e]=!0,s.push(e)),this.occupation[i]=o.update[i]}this.ui_update_rooms(s,!0)},o.prototype.msg_roomMap=function(o){var t=this;this.roomMap=o.roomMap,this.roomMapVersion=o.version,this.rroomMap={},this.rooms=[],this.maxPcsPerRoom=1;for(var s in this.roomMap){this.rooms.push(s),this.maxPcsPerRoom=Math.max(this.maxPcsPerRoom,this.roomMap[s][1].length);for(var i=0;this.roomMap[s][1].length>i;i++)this.rroomMap[this.roomMap[s][1][i]]=s}this.rooms.sort(function(o,s){return t.roomMap[s][1].length-t.roomMap[o][1].length}),this.ui_refresh_rooms(this.rooms)},o.prototype.ui_refresh_rooms=function(){this.roomToDom={},$("#list > .rows").empty();for(var o=!0,t=0;this.rooms.length>t;t++){var s=this.rooms[t],i=o?"odd":"even",e=$("<div class='"+i+"'><div class='bar'><div>"+"<div class='u'><div></div></div>"+"<div class='f'><div></div></div>"+"</div></div>"+"<div class='name'>"+this.roomMap[s][0]+"</div>"+"<div class='count'></div>"+"<div class='sched'><span class='screen'></span>"+"<span class='mobile'></span></div>"+"</div>");this.roomToDom[s]=e,$("#list > .rows").append(e),o=!o}this.ui_update_rooms(this.rooms,!1)},o.prototype.ui_update_schedule=function(){for(var o=this,t=new Date,s=[t.getHours(),t.getMinutes()],i=function(o,t){return o[0]!=t[0]?o[0]<=t[0]:o[1]<=t[1]},e=function(o){var t=""+o[1];return 1==t.length&&(t="0"+t),o[0]+":"+t},r=null,n=0;this.rooms.length>n;n++){var a=this.rooms[n],h=this.schedule[a];if(h){for(var c=null,u=null,m=0;h.length>m;m++){if(i(h[m][0],s)&&i(s,h[m][1])){c=h[m],u=!0;break}i(s,h[m][0])&&(null==c||i(h[m][0],c))&&(c=h[m],u=!1)}var p=null;if(null==c)var l="",d="",f=null;else if(u){var l="gereserveerd tot "+e(c[1])+" voor “"+c[2]+"”",d="gereserveerd tot "+e(c[1]),f="resNow";p=c[1]}else{var l="gereserveerd vanaf  "+e(c[0])+" tot "+e(c[1])+" voor “"+c[2]+"”",d="gereserveerd "+e(c[0])+"–"+e(c[1]),f="resLater";p=c[0]}null==p||null!=r&&!i(p,r)||(r=p),this.roomToDom[a].find(".sched > .screen").text(l),this.roomToDom[a].find(".sched > .mobile").html(d);var v=this.roomToDom[a].find(".bar > div");v.removeClass(),f&&v.addClass(f)}}if(null!=r){var g=new Date(t.getUTCFullYear(),t.getMonth(),t.getDate(),r[0],r[1]);null!=this.schedTimeout&&clearTimeout(this.schedTimeout),this.schedTimeout=setTimeout(function(){o.ui_update_schedule()},g-t)}},o.prototype.ui_update_rooms=function(o,t){for(var s=0;o.length>s;s++){for(var i=o[s],e=this.roomToDom[i],r={wf:0,lf:0,o:0,wu:0,wx:0,lu:0,lx:0,x:0},n=0;this.roomMap[i][1].length>n;n++){var a=this.occupation[this.roomMap[i][1][n]];r[a]++}var h=r.wf+r.lf+r.o,c=r.wu+r.wx+r.lu+r.lx+r.x,u=100/this.maxPcsPerRoom,m={width:u*h+"%"},p={width:u*(c+h)+"%"};t?(e.find(".f").animate(m),e.find(".u").animate(p)):(e.find(".f").css(m),e.find(".u").css(p)),e.find(".count").text(h+"/"+(c+h)),t&&e.stop(!0,!0,!0).effect("highlight",{},1e3)}},$(document).ready(function(){setTimeout(function(){tkb=new o,tkb.run()},0)})})();