(function(){function a(){this.comet=null,this.roomMapVersion=-1,this.occupationVersion=-1,this.scheduleVersion=-1,this.roomMap={},this.occupation={},this.schedule={},this.rroomMap={},this.roomToDom={},this.rooms=[],this.maxPcsPerRoom=1,this.schedTimeout=null,this.firstOccupation=!0,this.msg_map={welcome:this.msg_welcome,occupation:this.msg_occupation,roomMap:this.msg_roomMap,schedule:this.msg_schedule,occupation_update:this.msg_occupation_update}}a.prototype.setup_comet=function(){var a=this,b={};tkbConfig.hasOwnProperty("host")&&(b.host=tkbConfig.host),tkbConfig.hasOwnProperty("port")&&(b.port=tkbConfig.port),this.comet=new joyceCometClient(b),this.channel=this.comet.create_channel({message:function(b){var c=b.type;c in a.msg_map?a.msg_map[c].call(a,b):console.warn(["I don't know how to handle",b])}})},a.prototype.run=function(){this.setup_comet()},a.prototype.msg_welcome=function(a){},a.prototype.msg_schedule=function(a){this.schedule=a.schedule,this.scheduleVersion=a.version,this.ui_update_schedule()},a.prototype.msg_occupation=function(a){this.occupation=a.occupation,this.occupationVersion=a.version,this.ui_update_rooms(this.rooms,!1),this.firstOccupation&&(this.firstOccupation=!1,window.scrollTo(0,1))},a.prototype.msg_occupation_update=function(a){if(a.version!=this.occupationVersion+1){log.warn("Apparently we missed some updates; resynching"),this.comet.send_message("get_occupation");return}this.occupationVersion++;var b={},c=[];for(var d in a.update){var e=this.rroomMap[d];b[e]||(b[e]=!0,c.push(e)),this.occupation[d]=a.update[d]}this.ui_update_rooms(c,!0)},a.prototype.msg_roomMap=function(a){var b=this;this.roomMap=a.roomMap,this.roomMapVersion=a.version,this.rroomMap={},this.rooms=[],this.maxPcsPerRoom=1;for(var c in this.roomMap){this.rooms.push(c),this.maxPcsPerRoom=Math.max(this.maxPcsPerRoom,this.roomMap[c].length);for(var d=0;d<this.roomMap[c].length;d++)this.rroomMap[this.roomMap[c][d]]=c}this.rooms.sort(function(a,c){return b.roomMap[c].length-b.roomMap[a].length}),this.ui_refresh_rooms(this.rooms)},a.prototype.ui_refresh_rooms=function(){this.roomToDom={},$("#list > .rows").empty();var a=!0;for(var b=0;b<this.rooms.length;b++){var c=this.rooms[b],d=a?"odd":"even",e=$("<div class='"+d+"'><div class='bar'><div>"+"<div class='u'><div></div></div>"+"<div class='f'><div></div></div>"+"</div></div>"+"<div class='name'>"+c+"</div>"+"<div class='count'></div>"+"<div class='sched'></div></div>");this.roomToDom[c]=e,$("#list > .rows").append(e),a=!a}this.ui_update_rooms(this.rooms,!1)},a.prototype.ui_update_schedule=function(){var a=this,b=new Date,c=[b.getHours(),b.getMinutes()],d=function(a,b){return a[0]!=b[0]?a[0]<=b[0]:a[1]<=b[1]},e=function(a){var b=a[1]+"";return b.length==1&&(b="0"+b),a[0]+":"+b},f=null;for(var g=0;g<this.rooms.length;g++){var h=this.rooms[g],i=this.schedule[h];if(!i)continue;var j=null,k=null;for(var l=0;l<i.length;l++){if(d(i[l][0],c)&&d(c,i[l][1])){j=i[l],k=!0;break}d(c,i[l][0])&&(j==null||d(i[l][0],j))&&(j=i[l],k=!1)}var m=null;if(j==null)var n="",o=null;else if(k){var n="gereserveerd tot "+e(j[1]),o="resNow";m=j[1]}else{var n="gereserveerd vanaf  "+e(j[0]),o="resLater";m=j[0]}m!=null&&(f==null||d(m,f))&&(f=m),this.roomToDom[h].find(".sched").text(n);var p=this.roomToDom[h].find(".bar > div");p.removeClass(),o&&p.addClass(o)}if(f==null)return;var q=new Date(b.getUTCFullYear(),b.getMonth(),b.getDate(),f[0],f[1]);this.schedTimeout!=null&&clearTimeout(this.schedTimeout),this.schedTimeout=setTimeout(function(){a.ui_update_schedule()},q-b)},a.prototype.ui_update_rooms=function(a,b){for(var c=0;c<a.length;c++){var d=a[c],e=this.roomToDom[d],f={wf:0,lf:0,o:0,wu:0,wx:0,lu:0,lx:0,x:0};for(var g=0;g<this.roomMap[d].length;g++){var h=this.occupation[this.roomMap[d][g]];f[h]++}var i=f.wf+f.lf+f.o,j=f.wu+f.wx+f.lu+f.lx+f.x,k=100/this.maxPcsPerRoom,l={width:k*i+"%"},m={width:k*(j+i)+"%"};b?(e.find(".f").animate(l),e.find(".u").animate(m)):(e.find(".f").css(l),e.find(".u").css(m)),e.find(".count").text(i+"/"+(j+i)),b&&e.stop(!0,!0,!0).effect("highlight",{},1e3)}},$(document).ready(function(){setTimeout(function(){tkb=new a,tkb.run()},0)})})();